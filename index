<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV íŒŒì¼ ë³‘í•©ê¸° (v2.7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .drop-zone {
            transition: background-color 0.2s ease;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white w-full max-w-2xl rounded-xl shadow-lg p-8">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">ğŸ—‚ï¸ CSV íŒŒì¼ ë³‘í•©ê¸°</h1>
            <p class="text-slate-600 mt-2">ì—¬ëŸ¬ êµ­ê°€ì˜ Sales Reportë¥¼ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ë³‘í•©í•©ë‹ˆë‹¤. (v2.7)</p>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="drop-zone border-4 border-dashed border-slate-300 rounded-lg p-12 text-center cursor-pointer bg-slate-50 hover:bg-slate-100">
            <input type="file" id="fileInput" multiple class="hidden" accept=".csv">
            <div class="flex flex-col items-center">
                <!-- [v2.7] ì•„ì´ì½˜ ë³€ê²½ -->
                <svg class="w-16 h-16 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                </svg>
                <p class="mt-4 text-lg font-semibold text-slate-700">íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì„¸ìš”</p>
                <p class="text-slate-500">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
            </div>
        </div>

        <!-- File List -->
        <div id="fileListContainer" class="mt-6 hidden">
            <h3 class="font-semibold text-slate-700">ì„ íƒëœ íŒŒì¼:</h3>
            <ul id="fileList" class="mt-2 list-disc list-inside text-slate-600 space-y-1">
                <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </ul>
        </div>

        <!-- Action Button & Spinner -->
        <div class="mt-8 text-center">
            <button id="mergeButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center" disabled>
                <span id="buttonText">íŒŒì¼ ë³‘í•© ë° ë‹¤ìš´ë¡œë“œ</span>
                <div id="spinner" class="spinner w-5 h-5 border-4 border-t-blue-500 border-white rounded-full ml-3 hidden"></div>
            </button>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="mt-4 text-center"></div>

    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const mergeButton = document.getElementById('mergeButton');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const statusMessage = document.getElementById('statusMessage');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('buttonText');

        let selectedFiles = [];

        // [v2.6] ìµœì¢… ì¶œë ¥ë  ê³ ì • ì»¬ëŸ¼ ìˆœì„œ ì •ì˜
        const TARGET_COLUMNS = [
            'Date', 'Country', 'ASIN', 'Parent ASIN', 'Product Title', 
            'Brand', 'Model Number', 'Category', 'Subcategory', 
            'MSRP', 'Revenue', 'Units'
        ];

        // ë“œë¡­ì¡´ ì´ë²¤íŠ¸
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        /**
         * íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
         */
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === 'text/csv' || file.name.endsWith('.csv'));
            
            fileList.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
            if (selectedFiles.length > 0) {
                fileListContainer.classList.remove('hidden');
                selectedFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = file.name;
                    fileList.appendChild(li);
                });
                mergeButton.disabled = false;
            } else {
                fileListContainer.classList.add('hidden');
                mergeButton.disabled = true;
                showStatus('CSV íŒŒì¼ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        /**
         * ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
         */
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            if (type === 'error') {
                statusMessage.className = 'mt-4 text-center text-red-600 font-semibold';
            } else if (type === 'success') {
                statusMessage.className = 'mt-4 text-center text-green-600 font-semibold';
            } else {
                statusMessage.className = 'mt-4 text-center text-slate-600';
            }
        }

        /**
         * ë³‘í•© ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
         */
        mergeButton.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                showStatus('ë³‘í•©í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // UIë¥¼ ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
            mergeButton.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'ë³‘í•© ì¤‘...';
            showStatus('íŒŒì¼ì„ ì½ê³  ì²˜ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');

            try {
                const allRows = []; // ëª¨ë“  íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ë‹´ì„ ë°°ì—´
                let processedCount = 0;

                // [v2.6] ê³µí†µ í—¤ë” (ê³ ì •ë¨)
                const finalHeader = TARGET_COLUMNS;

                for (const file of selectedFiles) {
                    try {
                        // 1. íŒŒì¼ ë©”íƒ€ë°ì´í„°(ë‚ ì§œ, êµ­ê°€) ì¶”ì¶œ
                        const { country, date } = extractMetadata(file.name);
                        if (date === 'Unknown' || country === 'Unknown') {
                            throw new Error(`íŒŒì¼ '${file.name}'ì—ì„œ ë‚ ì§œ ë˜ëŠ” êµ­ê°€ ì½”ë“œë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ëª…ì„ í™•ì¸í•˜ì„¸ìš”.`);
                        }
                        
                        // 2. íŒŒì¼ ë‚´ìš© ì½ê¸°
                        const content = await file.text();
                        
                        // 3. íŒŒì¼ ë‚´ìš© ì²˜ë¦¬ (í—¤ë” ë§¤í•‘ ë° ë°ì´í„° ì¶”ì¶œ)
                        const fileRows = processFileContent(content, date, country);
                        
                        // 4. ì „ì²´ ë°ì´í„°ì— ì¶”ê°€
                        allRows.push(...fileRows);

                        processedCount++;
                        showStatus(`íŒŒì¼ ì²˜ë¦¬ ì¤‘... (${processedCount}/${selectedFiles.length}) - ${file.name}`, 'info');

                    } catch (fileError) {
                        console.error(`[CONSOLE_ERROR] íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${fileError.stack}`);
                        showStatus(`ì˜¤ë¥˜: ${fileError.message}`, 'error');
                        // í•˜ë‚˜ì˜ íŒŒì¼ì´ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í•˜ì§€ ì•Šê³  ì¤‘ë‹¨
                        throw fileError; 
                    }
                }

                if (allRows.length === 0) {
                    showStatus('ë³‘í•©í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (Units=0ì¸ í–‰ë§Œ ìˆì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)', 'error');
                    resetUI();
                    return;
                }

                // 5. ëª¨ë“  ë°ì´í„°ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜
                showStatus('ìµœì¢… CSV íŒŒì¼ ìƒì„± ì¤‘...', 'info');

                // [v2.6] ìµœì¢… í—¤ë”ë¥¼ TARGET_COLUMNS ìˆœì„œëŒ€ë¡œ ìƒì„±
                const headerString = finalHeader.map(h => `"${h.replace(/"/g, '""')}"`).join(',');
                
                const csvRows = allRows.map(row => {
                    // [v2.6] TARGET_COLUMNSì— ì •ì˜ëœ ìˆœì„œëŒ€ë¡œ ê°’ì„ ë§¤í•‘
                    const orderedRow = finalHeader.map(colName => {
                        const value = row[colName] || ''; // í•´ë‹¹ ì»¬ëŸ¼ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
                        return `"${String(value).replace(/"/g, '""')}"`; // ë˜í•‘
                    });
                    return orderedRow.join(',');
                });

                const finalCsvContent = [headerString, ...csvRows].join('\n');

                // 6. CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                downloadCsv(finalCsvContent, 'merged_sales_report.csv');
                showStatus(`ì„±ê³µ! ì´ ${allRows.length}ê°œì˜ í–‰ì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

            } catch (error) {
                console.error(`[CONSOLE_ERROR] ì „ì²´ ë³‘í•© í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜: ${error.stack}`);
                if (!statusMessage.textContent.startsWith('ì˜¤ë¥˜:')) {
                    showStatus('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
                }
            } finally {
                // UI ì´ˆê¸°í™”
                resetUI();
            }
        });

        /**
         * UI ì´ˆê¸°í™”
         */
        function resetUI() {
            mergeButton.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'íŒŒì¼ ë³‘í•© ë° ë‹¤ìš´ë¡œë“œ';
            fileInput.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
            selectedFiles = [];
            fileListContainer.classList.add('hidden');
            fileList.innerHTML = '';
        }

        /**
         * íŒŒì¼ëª…ì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (ë‚ ì§œ, êµ­ê°€)
         */
        function extractMetadata(filename) {
            let country = 'Unknown';
            let date = 'Unknown';

            // 1. êµ­ê°€ ì½”ë“œ ì¶”ì¶œ
            if (filename.includes('UnitedKingdom')) country = 'UK';
            else if (filename.includes('Canada')) country = 'CA';
            else if (filename.includes('Japan')) country = 'JP';

            // 2. ë‚ ì§œ ì¶”ì¶œ (YYYY-MM-DD, MM-DD-YYYY, DD-MM-YYYY)
            // YYYY-MM-DD (ì˜ˆ: _2024-11-21_)
            let match = filename.match(/_(\d{4}-\d{2}-\d{2})_/);
            if (match && match[1]) {
                date = match[1];
            } else {
                // MM-DD-YYYY (ì¼ë³¸) ë˜ëŠ” DD-MM-YYYY (UK)
                // (ì›”/ì¼ì´ 1~2ìë¦¬, ì—°ë„ê°€ 4ìë¦¬)
                match = filename.match(/_(\d{1,2}-\d{1,2}-\d{4})_/);
                if (match && match[1]) {
                    const parts = match[1].split('-'); // ì˜ˆ: ["10", "31", "2025"] ë˜ëŠ” ["31", "10", "2025"]
                    
                    if (country === 'UK') {
                        // UK: DD-MM-YYYY
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        date = `${year}-${month}-${day}`; // 2025-10-31
                    } else {
                        // JP (ë° ê¸°íƒ€): MM-DD-YYYY
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        const year = parts[2];
                        date = `${year}-${month}-${day}`; // 2025-10-31
                    }
                }
            }

            return { country, date };
        }

        /**
         * CSV íŒŒì¼ ë‚´ìš© ì²˜ë¦¬
         */
        function processFileContent(content, date, country) {
            const lines = content.split('\n').filter(line => line.trim() !== ''); // ë¹ˆ ì¤„ ì œê±°
            if (lines.length < 2) {
                // í—¤ë”ì¡°ì°¨ ì—†ëŠ” íŒŒì¼
                return []; 
            }

            const headerLine = lines[1]; // 2ë²ˆì§¸ ì¤„ì„ í—¤ë”ë¡œ ì‚¬ìš©
            const header = parseCsvLine(headerLine);
            const indices = normalizeHeader(header); // ì¤‘ìš” ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°

            // [v2.6] ìƒˆ ì»¬ëŸ¼ë“¤ ì¸ë±ìŠ¤ í™•ì¸
            if (indices.asin === -1 || indices.productTitle === -1) {
                console.warn(`íŒŒì¼ ${date}_${country}ì—ì„œ ASIN ë˜ëŠ” Product Title ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                // í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì´ íŒŒì¼ì„ ê±´ë„ˆëœë‹ˆë‹¤.
                return []; 
            }

            const fileRows = [];
            // 3ë²ˆì§¸ ì¤„(ì¸ë±ìŠ¤ 2)ë¶€í„° ë°ì´í„°ë¡œ ì²˜ë¦¬
            for (let i = 2; i < lines.length; i++) {
                const values = parseCsvLine(lines[i]);
                if (values.length < header.length) {
                    continue; // í—¤ë”ë³´ë‹¤ ì§§ì€ ë¶ˆì™„ì „í•œ ë¼ì¸ ìŠ¤í‚µ
                }
                
                const asin = values[indices.asin] || '';
                const productTitle = values[indices.productTitle] || '';

                // Revenue/Units ë¡œì§ ì ìš© (Ordered ìš°ì„ )
                let revenue = (values[indices.revenueOrdered] || values[indices.revenueShipped]) || '';
                const units = (values[indices.unitsOrdered] || values[indices.unitsShipped]) || '';

                // Revenue í†µí™”ê¸°í˜¸/ì‰¼í‘œ ì œê±°
                revenue = revenue.replace(/[^\d.-]/g, '');

                // 'Units'ê°€ 0ì´ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ í–‰ ì œê±°
                if (units === '0' || units.trim() === '') {
                    continue; 
                }

                // [v2.6] ì‹ ê·œ ì»¬ëŸ¼ ë°ì´í„° ì¶”ì¶œ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
                const brand = values[indices.brand] || '';
                const category = values[indices.category] || '';
                const subcategory = values[indices.subcategory] || '';
                const parentAsin = values[indices.parentAsin] || '';
                const modelNumber = values[indices.modelNumber] || '';
                
                // [v2.7] MSRP ê°’ ì •ì œ (í†µí™”ê¸°í˜¸, ì‰¼í‘œ ë“± ì œê±°)
                let msrp = values[indices.msrp] || '';
                msrp = msrp.replace(/[^\d.-]/g, '');

                // [v2.6] ê³ ì •ëœ í‚¤ë¥¼ ê°€ì§„ ê°ì²´ ìƒì„± (TARGET_COLUMNSì™€ í‚¤ ì´ë¦„ ì¼ì¹˜)
                fileRows.push({
                    'Date': date,
                    'Country': country,
                    'ASIN': asin,
                    'Product Title': productTitle,
                    'Revenue': revenue,
                    'Units': units,
                    'Brand': brand,
                    'Category': category,
                    'Subcategory': subcategory,
                    'Parent ASIN': parentAsin,
                    'Model Number': modelNumber,
                    'MSRP': msrp
                });
            }
            return fileRows;
        }

        /**
         * í—¤ë” ë°°ì—´ì„ ë°›ì•„ ì¤‘ìš” ì»¬ëŸ¼ì˜ ì¸ë±ìŠ¤ë¥¼ ë§¤í•‘
         */
        function normalizeHeader(headerArray) {
            const normalized = {};
            const findIndex = (possibleNames) => {
                for (const name of possibleNames) {
                    const index = headerArray.findIndex(h => h.trim().toLowerCase() === name.toLowerCase());
                    if (index !== -1) return index;
                }
                return -1;
            };

            normalized.asin = findIndex(['asin']);
            normalized.productTitle = findIndex(['product title', 'producttitle']); // 'Product title' (UK), 'Product Title' (JP)
            
            normalized.revenueOrdered = findIndex(['ordered revenue', 'orderedrevenue']);
            normalized.unitsOrdered = findIndex(['ordered units', 'orderedunits']);
            
            // UK 'Dispatched' / JP/CA 'Shipped'
            normalized.revenueShipped = findIndex(['shipped revenue', 'shippedrevenue', 'dispatched revenue', 'dispatchedrevenue']);
            normalized.unitsShipped = findIndex(['shipped units', 'shippedunits', 'dispatched units', 'dispatchedunits']);

            // [v2.6] ì‹ ê·œ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ë§¤í•‘
            normalized.brand = findIndex(['brand']);
            normalized.category = findIndex(['category']);
            normalized.subcategory = findIndex(['subcategory']);
            normalized.parentAsin = findIndex(['parent asin', 'parentasin']);
            normalized.modelNumber = findIndex(['model number', 'modelnumber']);
            normalized.msrp = findIndex(['msrp']);

            return normalized;
        }

        /**
         * CSV í•œ ì¤„ì„ íŒŒì‹± (ë”°ì˜´í‘œ ì•ˆì˜ ì‰¼í‘œ ì²˜ë¦¬)
         */
        function parseCsvLine(line) {
            const values = [];
            let current = '';
            let inQuote = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"' && line[i+1] === '"') {
                    // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ ("") ì²˜ë¦¬
                    current += '"';
                    i++; // ë‹¤ìŒ ë¬¸ì ê±´ë„ˆë›°ê¸°
                } else if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim()); // ë§ˆì§€ë§‰ ê°’ ì¶”ê°€
            return values;
        }

        /**
         * CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
         */
        function downloadCsv(content, filename) {
            // UTF-8 BOMì„ ì¶”ê°€í•˜ì—¬ Excelì—ì„œ í•œê¸€/íŠ¹ìˆ˜ë¬¸ìê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡ í•¨
            const bom = '\uFEFF';
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
